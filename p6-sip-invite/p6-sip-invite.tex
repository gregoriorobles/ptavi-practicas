%
% $Id: $
%

%\documentclass[times,10pt,twocolumn]{article}
%\documentclass[times,12pt]{article}
\documentclass[a4paper,11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{times}


\newcommand{\finejercicio}{
  \begin{footnotesize}
    [Al terminar el ejercicio es recomendable hacer \texttt{commit} de los ficheros modificados]
  \end{footnotesize}
}

\newcommand{\finpractica}{
  \begin{footnotesize}
    [Al terminar la práctica, realiza un \texttt{push} para sincronizar tu repositorio GitLab]
  \end{footnotesize}
}

%\documentstyle[times,art12,format/latex8]{article}

\usepackage{url}

\usepackage{fullpage}
\usepackage{subfigure}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{psfrag}
\usepackage{epsfig}
\usepackage{graphicx}
\usepackage{graphics}

% COMMENTS (optional argument is author of comment)
\newcommand{\comments}[2][?]{
  \begin{quote}
    \textbf{Comment (#1):} {\em #2}
  \end{quote}
  }
%% Uncomment this line to remove comments
%\renewcommand{\comments}[2][?]{}


%-------------------------------------------------------------------------
% take the % away on next line to produce the final camera-ready version
\pagestyle{empty}

%-------------------------------------------------------------------------
\begin{document}


\title{Práctica 6 - Sesión SIP \emph{peer-to-peer}}
\author{Protocolos para la Transmisión de Audio y Vídeo en Internet}
\date{Versión 11.0 -- 2.12.2020}

%\author{Gregorio Robles y Jesús M. González Barahona \\
%  grex@gsyc.urjc.es \\
%  Grupo de Sistemas y Comunicaciones \\
%  Universidad Rey Juan Carlos
%}

%\date{Febrero 2010}

\maketitle
\thispagestyle{empty}

%\maketitle
%\tableofcontents
%\newpage

%-------------------------------------------------------------------------

Nota: Esta práctica se puede entregar para su evaluación como parte de la nota de prácticas, pudiendo obtener el estudiante hasta 0,7 puntos. Para las instrucciones de entrega, mira al final del documento.

\section*{Introducción}

Esta práctica tiene como objetivo implementar dos programas Python,
de manera que se pueda realizar una sesión SIP como la que se
muestra en la siguiente figura\footnote{En la figura las respuestas SIP están en 
mayúsculas para mejorar su lectura; en tu implementación deberían seguir el 
estándar, en el que sólo la primera letra es mayúscula}:

\begin{center}
\includegraphics{figs/sip-invite.png}
\end{center}

En esta sesión:

\begin{itemize}
  \item No habrá ni servidor de registro ni \emph{proxy}. La comunicación será \emph{peer-to-peer} (directa entre dos UAs\footnote{UA: User Agent. Un UA se compone de un cliente y un servidor, aunque en esta práctica -por simplificación- cada UA tendrá sólo una de las dos partes.}).
  \item El UA de la izquierda constará exclusivamente de la parte cliente. Esta parte será la que inicie la sesión con un \texttt{INVITE} y la cierre con un \texttt{BYE}.
  \item El UA de la derecha constará exclusivamente de la parte servidora. Esta parte será la que envíe el audio vía RTP al cliente.
\end{itemize}


\section*{Objetivos de la práctica}

\begin{itemize}
  \item Implementación de una conversación de audio iniciada con SIP.
\end{itemize}

\section*{Conocimientos previos necesarios}

\begin{itemize}
  \item Nociones de SIP (las de clase de teoría)
  \item Funcionamiento de \texttt{wireshark}.
\end{itemize}

Tiempo estimado: 10 horas

\section*{Creación de repositorio para la práctica}

Con el navegador, dirígete al repositorio \texttt{ptavi-p6} en la cuenta del profesor en GitLab\footnote{\url{http://gitlab.etsit.urjc.es/ptavi/ptavi-p6}} y realiza un \texttt{fork}, de manera que consigas tener una copia del repositorio en tu cuenta de GitLab. Clona el repositorio que acabas de crear a local para poder editar los archivos. Trabaja a partir de ahora en ese repositorio, sincronizando los cambios que vayas realizando.

 Como tarde al final de la práctica, deberás realizar un \texttt{push} para subir tus cambios a tu repositorio en GitLab. En esta práctica, al contrario que con las demás, se recomienda hacer frecuentes \texttt{commits}, pero el \texttt{push} al final.


\section*{Parte cliente}

El cliente ha de ejecutarse de la siguiente manera:
\begin{verbatim}
  $ python3 client.py metodo receptor@IPreceptor:puertoSIP
\end{verbatim}

donde \emph{metodo} será un método SIP, \texttt{receptor@IPreceptor:puertoSIP}
será el login, la IP y el puerto\footnote{En el mundo ``real'', el puerto sería 
el puerto de SIP por defecto, el 5060, ya que sólo puede haber un UA activo
por máquina - si arrancas otro UA SIP cuando hay uno ya lanzado, no te dejará.
Como en la práctica final tendremos dos UAs en la
misma máquina, hemos de especificar un puerto para que no se ``pisen''.}
al que se dirige el mensaje.

Por ejemplo:
\begin{verbatim}
  $ python3 client.py INVITE batman@193.147.73.20:5555
  $ python3 client.py BYE robin@193.147.73.20:5555
\end{verbatim}

En caso de no introducir el número de parámetros correctos o de error en los mismos, el programa debería imprimir siempre por pantalla:

\begin{verbatim}
  Usage: python3 client.py method receiver@IP:SIPport
\end{verbatim}

\subsection*{Peticiones SIP}

El cliente debería poder enviar las siguientes peticiones SIP:

  \begin{itemize}
    \item INVITE sip:receptor@IP SIP/2.0

    Mediante este método, el UA indica que quiere iniciar una conversación con el receptor con dirección \emph{receptor} en la máquina dada por la \emph{IP}\footnote{La IP puede ser 127.0.0.1.}.

    \item ACK sip:receptor@IP SIP/2.0

    Método de asentimiento. No se pasará al programa \texttt{client.py} como parámetro desde
la \texttt{shell}, ya que se enviará de manera automática una vez se hayan recibido las respuestas \texttt {100 Trying}, \texttt{180 Ring} y \texttt{200 OK} de la parte servidora.

    \item BYE sip:receptor@IP SIP/2.0

    Mediante este método se indica que queremos terminar una conversación con el receptor con dirección \emph{receptor} en la máquina dada por la IP. Se deberá enviar una vez haya acabado de recibir \emph{streaming} de audio (vía RTP) enviado desde el servidor.

  \end{itemize}


\section*{Parte servidora}

El servidor ha de ejecutarse de la siguiente manera:
\begin{verbatim}
  $ python3 server.py IP puerto fichero_audio
\end{verbatim}

Por ejemplo:
\begin{verbatim}
  $ python3 server.py 127.0.0.1 5555 cancion.mp3
\end{verbatim}

En caso de no introducir el número de parámetros correctos o de error en los mismos (se ha de comprobar si existe el fichero de audio), el programa debería imprimir:
\begin{verbatim}
  Usage: python3 server.py IP port audio_file
\end{verbatim}

En caso de no haber error al arrancar, el servidor imprimirá por pantalla:
\begin{verbatim}
  Listening...
\end{verbatim}

\subsection*{Códigos de respuesta}

   \begin{itemize}
     \item \texttt{SIP/2.0 100 Trying}: al recibir un INVITE.
     \item \texttt{SIP/2.0 180 Ringing}: al recibir un INVITE.
     \item \texttt{SIP/2.0 200 OK}: en caso de éxito.
     \item \texttt{SIP/2.0 400 Bad Request}: si la petición está mal formada.
     \item \texttt{SIP/2.0 405 Method Not Allowed}: si se manda en la petición cualquier otro método diferente de INVITE, BYE o ACK.
   \end{itemize}

Para simplificar la práctica, se enviará {\bf en un único mensaje} (i.e., un único paquete) la respuesta \texttt{SIP/2.0 100 Trying}, \texttt{SIP/2.0 180 Ringing} y \texttt{SIP/2.0 200 OK}.

\subsection*{Envío RTP}

El envío RTP se realizará mediante la biblioteca \texttt{simplertp}\footnote{En el repositorio se encuentra el módulo Python \texttt{simplertp.py}}. {\bf Como en esta práctica no se hace uso de SDP para describir la sesión, se utilizará la IP 127.0.0.1 y el puerto 23032 como destino del envío}. Un ejemplo del código Python de envío de paquetes RTP sería el siguiente:

\begin{verbatim}
  import simplertp

  RTP_header = simplertp.RtpHeader()
  audio = simplertp.RtpPayloadMp3(audio_file)
  simplertp.send_rtp_packet(RTP_header, audio, ip, port)
\end{verbatim}

Nótese que \texttt{audio\_file} es uno de los parámetros que se le pasa al servidor al ejecutarse desde la línea de shell como parámetro. También ha de notarse que si sale el aviso {\bf Warning: Connection refused. Probably there is nothing listening on the other end.} es porque no hay ningún servicio \emph{escuchando} al otro lado; esto no es un error.

\section*{Captura}

Una vez terminada la práctica, se pide que se realice una captura de un
establecimiento de llamada, el envío RTP de audio y la finalización de
la llamada. 

La captura original se filtrará para que sólo incluya los paquetes
SIP y los tres primeros y tres últimos paquetes RTP con audio\footnote{Los heurísticos de Wireshark puede que no identifiquen los paquetes RTP como tales, sino como paquetes UDP. La solución es la siguiente: en el menú de ``Analyze'', selecciona ``Enabled protocols'' y ahí busca por RTP para activar ``rtp\_udp''.}.

La captura filtrada resultante se guardará en el fichero \texttt{invite.libpcap}
y se subirá al repositorio.


\section*{Fecha y modo de entrega}

La entrega de práctica se deberá hacer antes del miércoles 16 de diciembre de 2020 a las 23:59. Para entonces, se debe tener un repositorio git en GitLab con: 

    \begin{itemize}
        \item 2 módulos Python y la captura realizada con \texttt{wireshark}:
    \begin{itemize}
      \item \texttt{server.py}
      \item \texttt{client.py}
      \item \texttt{invite.libpcap}
    \end{itemize}
\end{itemize}

Se han de tener en cuenta las siguientes consideraciones:
\begin{itemize}
  \item Se valorará que al menos haya diez \emph{commits} realizados en al menos dos días diferentes.
  \item Se valorará que la captura esté bien filtrada y sólo contenga los paquetes que se indican en el guión.
  \item Se valorará que el código entregado siga la guía de estilo de Python (véanse PEP8 y PEP257).
  \item Se valorará que los programas se invoquen correctamente y que muestren los errores correctamente, según se indica en el enunciado de la práctica.
\end{itemize}

Se puede comprobar la correcta entrega de la práctica utilizando el programa \texttt{check-p6.py}. Este programa se ejecuta desde la línea de comandos de la siguiente manera:
\begin{verbatim}
  $ python3 check-p6.py login_gitlab
\end{verbatim}


donde \texttt{login\_gitlab} es tu nombre de usuario en GitLab.


%-------------------------------------------------------------------------
%\nocite{ex1,ex2}
%\bibliographystyle{format/latex8}
%\bibliography{libresoft}

\end{document}
